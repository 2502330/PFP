<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <title>Movie Catalog - Clean Blog</title>
        <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
        <!-- Font Awesome icons (free version)-->
        <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
        <!-- Google fonts-->
        <link href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css" />
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css" />
        <!-- Core theme CSS (includes Bootstrap)-->
        <link href="css/styles.css" rel="stylesheet" />
    </head>
    <body>
        <!-- Navigation-->
        <nav class="navbar navbar-expand-lg navbar-light" id="mainNav">
            <div class="container px-4 px-lg-5">
                <a class="navbar-brand" href="index.html">Movie Review</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive">
                    Menu
                </button>
                <div class="collapse navbar-collapse" id="navbarResponsive">
                    <ul class="navbar-nav ms-auto py-4 py-lg-0">
                        <li class="nav-item"><a class="nav-link px-lg-3 py-3 py-lg-4" href="index.html">Home</a></li>
                        <li class="nav-item"><a class="nav-link px-lg-3 py-3 py-lg-4" href="Catalog.html">Catalog</a></li>
                    </ul>
                </div>
            </div>
        </nav>

        <!-- Page Header-->
        <header class="masthead" style="background-image: url('assets/img/home-bg.jpg')">
            <div class="container position-relative px-4 px-lg-5">
                <div class="row gx-4 gx-lg-5 justify-content-center">
                    <div class="col-md-10 col-lg-8 col-xl-7">
                        <div class="page-heading">
                            <h1>Movie Catalog</h1>
                            <span class="subheading">Browse all movies with reviews and analysis</span>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content-->
        <div class="container px-4 px-lg-5" style="background: #222; min-height: 100vh; padding-top: 2rem; padding-bottom: 2rem;">
            <!-- Filters -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card bg-dark text-white">
                        <div class="card-header">
                            <h5>Filter Movies</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <label for="searchInput" class="form-label">Search</label>
                                    <input type="text" class="form-control" id="searchInput" placeholder="Movie title...">
                                </div>
                                <div class="col-md-2">
                                    <label for="genreFilter" class="form-label">Genre</label>
                                    <select class="form-select" id="genreFilter">
                                        <option value="">All Genres</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label for="minYear" class="form-label">Min Year</label>
                                    <select class="form-select" id="minYear">
                                        <option value="">Any</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label for="maxYear" class="form-label">Max Year</label>
                                    <select class="form-select" id="maxYear">
                                        <option value="">Any</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label for="ratingFilter" class="form-label">Min Rating</label>
                                    <select class="form-select" id="ratingFilter">
                                        <option value="">Any</option>
                                        <option value="7">7+</option>
                                        <option value="8">8+</option>
                                        <option value="9">9+</option>
                                    </select>
                                </div>
                                <div class="col-md-1 d-flex align-items-end">
                                    <button class="btn btn-primary" onclick="filterMovies()">Filter</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Movie Grid -->
            <div class="row" id="movieCatalog">
                <!-- Movies will be loaded here -->
            </div>

            <!-- Pagination -->
            <div class="row mt-4">
                <div class="col-12">
                    <div id="pagination"></div>
                </div>
            </div>

            <!-- Go to Page -->
            <div class="row mt-3">
                <div class="col-12 text-center">
                    <div class="input-group d-inline-flex" style="width: auto;">
                        <span class="input-group-text">Go to page:</span>
                        <input type="number" class="form-control" id="pageInput" style="width: 80px;" min="1">
                        <button class="btn btn-outline-secondary" id="goPageBtn">Go</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reviews Modal -->
        <div class="modal fade" id="reviewsModal" tabindex="-1" aria-labelledby="reviewsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content bg-dark text-light">
                    <div class="modal-header">
                        <h5 class="modal-title" id="reviewsModalLabel">Reviews & Analysis</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="reviewsModalBody">
                        <!-- Reviews and analysis will be injected here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Bootstrap core JS-->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
        <!-- Core theme JS-->
        <script src="js/scripts.js"></script>

        <script>
            const MOVIES_PER_PAGE = 18;
            let allMovies = [];
            let filteredMovies = [];
            let currentPage = 1;
            let allGenres = new Set();

            function renderMovieCard(movie, movieId) {
                return `
                <div class="col-lg-6 col-xl-4 mb-4">
                    <div class="card h-100 bg-dark text-white border-secondary">
                        <img src="${movie.poster || 'assets/img/placeholder-movie.jpg'}" class="card-img-top" alt="${movie.name || 'No Title'}" style="height:300px;object-fit:cover;" onerror="this.src='assets/img/placeholder-movie.jpg'">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">${movie.name || 'No Title'}</h5>
                            <p class="card-text"><strong>Genres:</strong> ${(movie.genres || []).slice(0, 3).join(', ')}</p>
                            <p class="card-text"><strong>Release Date:</strong> ${movie.date_published || 'N/A'}</p>
                            <p class="card-text"><strong>Rating:</strong> ${movie.rating || 'N/A'}/10</p>
                            <p class="card-text"><strong>Reviews:</strong> ${movie.reviews ? movie.reviews.length : 0}</p>
                            <button class="btn btn-primary mt-auto" onclick="showReviewsAndAnalysis('${movieId}')">View Reviews & Analysis</button>
                        </div>
                    </div>
                </div>
                `;
            }

            // Load movies from results.json
            fetch('../results/results.json')
                .then(res => res.json())
                .then(data => {
                    allMovies = data;
                    
                    // Collect all genres from all movies
                    Object.values(allMovies).forEach(movie => {
                        if (movie && movie.genres) {
                            movie.genres.forEach(genre => allGenres.add(genre));
                        }
                    });
                    
                    // Populate genre filter
                    const genreFilter = document.getElementById('genreFilter');
                    if (genreFilter) {
                        Array.from(allGenres).sort().forEach(g => {
                            const opt = document.createElement('option');
                            opt.value = g;
                            opt.textContent = g;
                            genreFilter.appendChild(opt);
                        });
                    }
                    
                    // Populate year dropdowns
                    populateYearDropdowns();
                    
                    filteredMovies = Object.entries(allMovies);
                    showPage(1);
                })
                .catch((error) => {
                    console.error('Error loading movies:', error);
                    const catalog = document.getElementById('movieCatalog');
                    if (catalog) {
                        catalog.innerHTML = '<div class="col-12 text-center text-danger">Failed to load movies. Please check if results.json is available.</div>';
                    }
                });

            function populateYearDropdowns() {
                const currentYear = new Date().getFullYear();
                const minYearDropdown = document.getElementById('minYear');
                const maxYearDropdown = document.getElementById('maxYear');

                // Populate years from 1900 to the current year
                for (let year = currentYear; year >= 1900; year--) {
                    const minOption = document.createElement('option');
                    minOption.value = year;
                    minOption.textContent = year;
                    minYearDropdown.appendChild(minOption);

                    const maxOption = document.createElement('option');
                    maxOption.value = year;
                    maxOption.textContent = year;
                    maxYearDropdown.appendChild(maxOption);
                }
            }

            function filterMovies() {
                const search = document.getElementById('searchInput').value.trim().toLowerCase();
                const genre = document.getElementById('genreFilter').value;
                const minYear = parseInt(document.getElementById('minYear').value, 10);
                const maxYear = parseInt(document.getElementById('maxYear').value, 10);
                const rating = parseFloat(document.getElementById('ratingFilter').value);

                filteredMovies = Object.entries(allMovies).filter(([movieId, movie]) => {
                    // Search by title
                    if (search && !(movie.name || '').toLowerCase().includes(search)) return false;
                    // Filter by genre
                    if (genre && (!movie.genres || !movie.genres.includes(genre))) return false;
                    // Filter by year
                    const year = movie.date_published ? parseInt(movie.date_published.slice(0,4), 10) : null;
                    if (!isNaN(minYear) && year && year < minYear) return false;
                    if (!isNaN(maxYear) && year && year > maxYear) return false;
                    // Filter by rating
                    if (!isNaN(rating) && parseFloat(movie.rating) < rating) return false;
                    return true;
                });
                showPage(1);
            }

            function showPage(page) {
                const catalog = document.getElementById('movieCatalog');
                const pagination = document.getElementById('pagination');
                const totalPages = Math.ceil(filteredMovies.length / MOVIES_PER_PAGE) || 1;

                if (page < 1 || page > totalPages) {
                    alert(`Please enter a valid page number between 1 and ${totalPages}.`);
                    return;
                }

                currentPage = page;
                const start = (page - 1) * MOVIES_PER_PAGE;
                const end = start + MOVIES_PER_PAGE;
                const moviesToShow = filteredMovies.slice(start, end);

                if (catalog) {
                    catalog.innerHTML = moviesToShow.map(([movieId, movie]) => renderMovieCard(movie, movieId)).join('');
                }
                
                if (pagination) {
                    pagination.innerHTML = renderPagination(totalPages, page);
                    pagination.querySelectorAll('.page-link').forEach(link => {
                        link.onclick = function (e) {
                            e.preventDefault();
                            showPage(Number(this.dataset.page));
                        };
                    });
                }
            }

            function renderPagination(totalPages, currentPage) {
                let html = `<nav aria-label="Movie catalog pagination"><ul class="pagination justify-content-center">`;

                if (currentPage > 1) {
                    html += `<li class="page-item"><a class="page-link" href="#" data-page="${currentPage - 1}">Previous</a></li>`;
                }

                let startPage = Math.max(1, currentPage - 2);
                let endPage = Math.min(totalPages, currentPage + 2);

                if (currentPage <= 3) {
                    endPage = Math.min(5, totalPages);
                } else if (currentPage >= totalPages - 2) {
                    startPage = Math.max(1, totalPages - 4);
                }

                for (let i = startPage; i <= endPage; i++) {
                    html += `<li class="page-item${i === currentPage ? ' active' : ''}">
                        <a class="page-link" href="#" data-page="${i}">${i}</a>
                    </li>`;
                }

                if (currentPage < totalPages) {
                    html += `<li class="page-item"><a class="page-link" href="#" data-page="${currentPage + 1}">Next</a></li>`;
                }

                html += `</ul></nav>`;
                return html;
            }

            function showReviewsAndAnalysis(movieId) {
                const movie = allMovies[movieId];
                if (!movie) return;

                const modal = document.getElementById('reviewsModal');
                const modalTitle = document.getElementById('reviewsModalLabel');
                const modalBody = document.getElementById('reviewsModalBody');

                if (!modal || !modalTitle || !modalBody) return;

                modalTitle.textContent = `Reviews & Analysis - ${movie.name}`;
                
                const analysisContent = createAnalysisContent(movie);
                const reviewsContent = createReviewsContent(movie);
                
                modalBody.innerHTML = `
                    ${analysisContent}
                    <hr class="my-4">
                    ${reviewsContent}
                `;

                const bootstrapModal = new bootstrap.Modal(modal);
                bootstrapModal.show();
            }

            function createAnalysisContent(movie) {
                if (!movie.analysis || movie.analysis.length === 0) {
                    return `
                        <div class="analysis-section mb-4">
                            <h5>Sentiment Analysis</h5>
                            <p class="text-muted">No analysis available for this movie.</p>
                        </div>
                    `;
                }

                const analysis = movie.analysis[0];
                
                return `
                    <div class="analysis-section mb-4">
                        <h5><i class="fas fa-chart-line me-2"></i>Sentiment Analysis</h5>
                        
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="analysis-card p-3 border rounded text-center">
                                    <h6 class="text-info">Overall Sentiment Score</h6>
                                    <h2 class="mb-0 ${analysis.total_score >= 0 ? 'text-success' : 'text-danger'}">
                                        ${analysis.total_score}
                                    </h2>
                                    <small class="text-muted">
                                        ${analysis.total_score >= 0 ? 'Positive Overall' : 'Negative Overall'}
                                    </small>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="analysis-card p-3 border rounded h-100">
                                    <h6 class="text-success"><i class="fas fa-smile me-2"></i>Most Positive Sentence</h6>
                                    <p class="small mb-0 fst-italic">"${analysis.most_pos_sentence || 'N/A'}"</p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="analysis-card p-3 border rounded h-100">
                                    <h6 class="text-danger"><i class="fas fa-frown me-2"></i>Most Negative Sentence</h6>
                                    <p class="small mb-0 fst-italic">"${analysis.most_neg_sentence || 'N/A'}"</p>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="analysis-card p-3 border rounded h-100">
                                    <h6 class="text-success"><i class="fas fa-paragraph me-2"></i>Most Positive Paragraph</h6>
                                    <div class="small" style="max-height: 150px; overflow-y: auto;">
                                        <p class="mb-0 fst-italic">"${analysis.most_pos_paragraph ? (analysis.most_pos_paragraph.length > 10000 ? analysis.most_pos_paragraph.substring(0, 500) + '...' : analysis.most_pos_paragraph) : 'N/A'}"</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="analysis-card p-3 border rounded h-100">
                                    <h6 class="text-danger"><i class="fas fa-paragraph me-2"></i>Most Negative Paragraph</h6>
                                    <div class="small" style="max-height: 150px; overflow-y: auto;">
                                        <p class="mb-0 fst-italic">"${analysis.most_neg_paragraph ? (analysis.most_neg_paragraph.length > 10000 ? analysis.most_neg_paragraph.substring(0, 500) + '...' : analysis.most_neg_paragraph) : 'N/A'}"</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="analysis-card p-3 border rounded h-100">
                                    <h6 class="text-success"><i class="fas fa-align-left me-2"></i>Most Positive Segment</h6>
                                    <div class="small" style="max-height: 200px; overflow-y: auto;">
                                        <p class="mb-0 fst-italic">"${analysis.most_pos_segment ? (analysis.most_pos_segment.length > 10000 ? analysis.most_pos_segment.substring(0, 800) + '...' : analysis.most_pos_segment) : 'N/A'}"</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="analysis-card p-3 border rounded h-100">
                                    <h6 class="text-danger"><i class="fas fa-align-left me-2"></i>Most Negative Segment</h6>
                                    <div class="small" style="max-height: 200px; overflow-y: auto;">
                                        <p class="mb-0 fst-italic">"${analysis.most_neg_segment ? (analysis.most_neg_segment.length > 10000 ? analysis.most_neg_segment.substring(0, 800) + '...' : analysis.most_neg_segment) : 'N/A'}"</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            function createReviewsContent(movie) {
                if (!movie.reviews || movie.reviews.length === 0) {
                    return `
                        <div class="reviews-section">
                            <h5><i class="fas fa-comments me-2"></i>Reviews</h5>
                            <p class="text-muted">No reviews available for this movie.</p>
                        </div>
                    `;
                }

                const reviewsHtml = movie.reviews.slice(0, 100).map((review, index) => `
                    <div class="review-item mb-3 p-3 border rounded">
                        <h6 class="text-info">Review ${index + 1}</h6>
                        <p class="mb-0">${review.length > 10000 ? review.substring(0, 10000) + '...' : review}</p>
                    </div>
                `).join('');

                return `
                    <div class="reviews-section">
                        <h5><i class="fas fa-comments me-2"></i>Reviews (Showing ${Math.min(100, movie.reviews.length)} of ${movie.reviews.length})</h5>
                        <div class="reviews-container" style="max-height: 400px; overflow-y: auto;">
                            ${reviewsHtml}
                        </div>
                    </div>
                `;
            }

            // Event listeners
            document.addEventListener('DOMContentLoaded', function() {
                const goBtn = document.getElementById('goPageBtn');
                const pageInput = document.getElementById('pageInput');

                if (goBtn && pageInput) {
                    goBtn.onclick = function () {
                        const val = parseInt(pageInput.value, 10);
                        if (!isNaN(val)) {
                            showPage(val);
                        } else {
                            alert('Please enter a valid page number.');
                        }
                    };

                    pageInput.onkeydown = function (e) {
                        if (e.key === 'Enter') {
                            const val = parseInt(pageInput.value, 10);
                            if (!isNaN(val)) {
                                showPage(val);
                            } else {
                                alert('Please enter a valid page number.');
                            }
                        }
                    };
                }

                // Filter event listeners
                document.getElementById('searchInput').addEventListener('input', filterMovies);
                document.getElementById('genreFilter').addEventListener('change', filterMovies);
                document.getElementById('minYear').addEventListener('change', filterMovies);
                document.getElementById('maxYear').addEventListener('change', filterMovies);
                document.getElementById('ratingFilter').addEventListener('change', filterMovies);
            });
        </script>

        <style>
            .analysis-card {
                background: rgba(255, 255, 255, 0.1);
                border-color: #444 !important;
            }
            .review-item {
                background: rgba(255, 255, 255, 0.05);
                border-color: #444 !important;
            }
            .reviews-container {
                scrollbar-width: thin;
                scrollbar-color: #666 #333;
            }
            .reviews-container::-webkit-scrollbar {
                width: 8px;
            }
            .reviews-container::-webkit-scrollbar-track {
                background: #333;
            }
            .reviews-container::-webkit-scrollbar-thumb {
                background: #666;
                border-radius: 4px;
            }
        </style>
    </body>
</html>